

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Welcome to The B.T.P.S Security Package’s documentation! &mdash; The B.T.P.S Security Package 2020 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: white" >
          

          
            <a href="#" class="icon icon-home"> The B.T.P.S Security Package
          

          
            
            <img src="_static/Logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">Welcome to The B.T.P.S Security Package’s documentation!</a><ul>
<li><a class="reference internal" href="#features-coming-soon">FEATURES COMING SOON</a><ul>
<li><a class="reference internal" href="#using-the-installer-ps1-file-to-get-started">Using the Installer.ps1 File to Get Started</a></li>
<li><a class="reference internal" href="#configure-winrm-over-https">Configure WinRM over HTTPS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#useful-winrm-info-and-commands-to-know">Useful WinRM Info and Commands To Know</a></li>
<li><a class="reference internal" href="#group-policy-windows-event-forwarding-wef-settings">Group Policy Windows Event Forwarding (WEF) Settings</a></li>
<li><a class="reference internal" href="#group-policy-winrm-settings">Group Policy WinRM Settings</a></li>
<li><a class="reference internal" href="#download-an-instructional-pdf-with-images-and-descriptions-for-installer-ps1-at-the-below-link">Download an Instructional PDF with images and descriptions for Installer.ps1 at the below link</a></li>
<li><a class="reference internal" href="#download-an-instructional-pdf-with-images-and-descriptions-for-installing-sysmon-at-the-below-link">Download an Instructional PDF with images and descriptions for installing Sysmon at the below link</a></li>
<li><a class="reference internal" href="#disclaimer">Disclaimer</a><ul>
<li><a class="reference internal" href="#indices-and-tables">Indices and tables</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="#">The B.T.P.S Security Package</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="#" class="icon icon-home"></a> &raquo;</li>
        
      <li>Welcome to The B.T.P.S Security Package’s documentation!</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/index.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="welcome-to-the-b-t-p-s-security-package-s-documentation">
<h1>Welcome to The B.T.P.S Security Package’s documentation!<a class="headerlink" href="#welcome-to-the-b-t-p-s-security-package-s-documentation" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/OsbornePro/BTPS-SecPack">GitHub Page</a></p></li>
<li><p><a class="reference external" href="https://gitlab.com/tobor88/BTPS-SecPack">GitLab Page</a></p></li>
<li><p><a class="reference external" href="https://www.paypal.com/cgi-bin/webscr?cmd=_donations&amp;business=AGKU5LWZA67XC&amp;currency_code=USD&amp;source=url">PayPal Donations</a></p></li>
<li><p><a class="reference external" href="https://liberapay.com/tobor/donate">LiberPay Donations</a></p></li>
<li><p><a class="reference external" href="https://osbornepro.com/schedule-or-contact">Report Issues</a></p></li>
</ul>
<p><strong>General Summary for this project can be read at</strong> <a class="reference external" href="https://github.com/tobor88/BTPS-SecPack/blob/master/README.md">https://github.com/tobor88/BTPS-SecPack/blob/master/README.md</a></p>
<p>The Installer.ps1 script is good to go. I created a virtual environment and ran everything from scratch to ensure you get the max protection and visibility possible with the least amount of fuss. If you experience any trouble please let me know so I am aware and can fix it. If you experience any issues or need help, feel free to reach out to me. My aim is to make this as easy to get going as possible. If something is to difficult or confusing please tell me about it. <a class="reference external" href="mailto:rosborne&#37;&#52;&#48;osbornepro&#46;com">rosborne<span>&#64;</span>osbornepro<span>&#46;</span>com</a> I am still adding content to this site as it is fairly new.</p>
<div class="section" id="features-coming-soon">
<h2>FEATURES COMING SOON<a class="headerlink" href="#features-coming-soon" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><strong>ELK SIEM Tool:</strong> I am going to set up a configuration for the ELK SIEM tool. This tool is free for certain uses and offers a purchase if desired. It will include <a class="reference external" href="https://www.elastic.co/elasticsearch/">Elasticsearch</a>, <a class="reference external" href="https://www.elastic.co/kibana">Kibana</a>, <a class="reference external" href="https://www.elastic.co/logstash">Logstash</a>, <a class="reference external" href="https://www.elastic.co/beats/winlogbeat">Winlogbeat</a>, and <a class="reference external" href="https://www.elastic.co/blog/geoip-in-the-elastic-stack">GeoIP</a>. The configuration is going to use the Windows Event Forwarding (WEF) configuration I cover in the <a class="reference external" href="https://btps-secpack.com/wef-application">WEF Application Setup</a>. The purpose of this is to prevent the need to install agents on the devices in your environment. The free version does not offer LDAP authentication unfortunately. The configuration will use TLS certificates to encrypt communications on the local host and listen for outside connections if you decide to install other stack programs such as <a class="reference external" href="https://www.elastic.co/apm">APM-Server</a>, <a class="reference external" href="https://www.elastic.co/beats/heartbeat">Heartbeat</a>, or <a class="reference external" href="https://www.elastic.co/beats/metricbeat">Metricbeat</a>. <a class="reference external" href="https://www.elastic.co/beats/winlogbeat">Winlogbeat</a> logs will be sent to <a class="reference external" href="https://www.elastic.co/logstash">Logstash</a> and modified to included <a class="reference external" href="https://www.elastic.co/blog/geoip-in-the-elastic-stack">GeoIP</a> tags that can be used for mapping IP addresses. Default passwords will of course also be changed. I will also create a Docker file that can be used to prevent the need for too much manual set up. When available it can be obtained from the Official OsbornePro LLC docker site: <a class="reference external" href="https://hub.docker.com/orgs/osbornepro">https://hub.docker.com/orgs/osbornepro</a></p></li>
<li><p>I am <strong>NO</strong> longer planning on integrating the <a class="reference external" href="https://support.virustotal.com/hc/en-us/articles/115002100149-API">Virus Total API</a> for MD5 hash comparisons. This does not provide enough cost per value however I will include a script to do this in case it is valuable to your situation.</p></li>
</ul>
<p><strong>IMPORTANT:</strong> This <strong>Blue Team PowerShell Security Package</strong>, assumes that you have referenced the <a class="reference external" href="https://www.malwarearchaeology.com/cheat-sheets/">Windows Event Logging Cheat Sheet</a> for logging in your environment. Use <a class="reference external" href="https://www.imfsecurity.com/free">LOG-MD</a> or <a class="reference external" href="https://www.cisecurity.org/cis-benchmarks/">CIS-CAT</a> (an SCAP Tool) to ensure the recommended logging is configured. These logging recommendations adhere to commonly accepted guidelines in the cyber security community. Even without the use of this security application, these guidelines should be followed to better assist your organization in the event of a compromise.</p>
<p><strong>CODE CONTRIBUTIONS</strong>
I am always open to suggestions and ideas as well as contributions if  anyone wishes to help add to this package. Credit will of course be given where credit is due. If you wish to contribute I have placed some info on that <a class="reference external" href="https://github.com/tobor88/BTPS-SecPack/blob/master/CONTRIBUTING.md">HERE</a>.</p>
<p><strong>What Purpose Does This Serve?</strong>
This repository contains a collection of PowerShell tools that can be utilized to protect and defend an environment based on the recommendations of multiple cyber security researchers at Microsoft. These tools were created with a small to medium size mostly Windows environment in mind as smaller organizations do not always have the type of funding available to overly spend on security. The goal of this project lines up with the goals of <a class="reference external" href="https://osbornepro.com/">OsbornePro LLC.</a> This exists to help add value to a smaller organization’s security by creating more visibility for the IT Administrator or Security Team.</p>
<p>For the case of organizations with 1,000’s of devices; you may find that this entire suite does not apply to you. This has to do with how some of the discoveries operate. For example the alert I have in the <a class="reference external" href="https://github.com/tobor88/BTPS-SecPack/tree/master/Device%20Discovery">Device Discovery</a> directory relies on DHCP assigned IP addresses. All DHCP servers in an environment are queried to create a list of known MAC addresses. This information is then saved to a CSV file for reference in discovering any new devices that join a network. This file could become too large to be effective. The other alert I can see not being effective is the <a class="reference external" href="https://github.com/tobor88/BTPS-SecPack/blob/master/Local%20Port%20Scan%20Monitor/Watch-PortScan.ps1">“Local Port Scan Alert”</a>. This is because if there is an over abundance of connections the script will not be able to cover all of the connections quickly enough. Other alerts in this security package are still appropriate no matter the network size as they are Event ID based typically. To begin, I suggest <a class="reference external" href="https://btps-secpack.com/winrm-over-https">Setting up WinRM over HTTPS</a> in your environment.</p>
<div class="toctree-wrapper compound">
</div>
<div class="section" id="using-the-installer-ps1-file-to-get-started">
<h3>Using the Installer.ps1 File to Get Started<a class="headerlink" href="#using-the-installer-ps1-file-to-get-started" title="Permalink to this headline">¶</a></h3>
<p>I wrote the <a class="reference external" href="https://github.com/OsbornePro/BTPS-SecPack/blob/master/Installer.ps1">Installer.ps1</a> script allow anyone to quickly and easily install as many protections as possible offered by the B.T.P.S. Security Package. Running this script requires very minimal to zero know how. You do not need to know how to download the Git repository. <a class="reference external" href="https://github.com/OsbornePro/BTPS-SecPack/blob/master/Installer.ps1">Installer.ps1</a> will do it for you :-)</p>
<p><strong>How can i get started using the Installer.ps1 install file?</strong>
Here is what you need to do in order to execute this file.</p>
<ol class="arabic simple">
<li><p>Log into your Primary Domain Controller using an account with Administrator permissions.</p></li>
<li><p>Open an Administrative PowerShell session (Windows Key + X, The press A).</p></li>
<li><p>Execute the command in step 4. This can be done by highlighting the command (starting from IEX all the way too /Installers.ps1. This command is all one line.). Right click the highlighted text and select “COPY”. Then Right Click inside your PowerShell window. If this does not paste right away you can paste by doing the key combo (Ctrl + V). This command executes all the text on that webpage inside of your powershell session without downloading the file to your disk drive.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">IEX</span> <span class="pre">(New-Object</span> <span class="pre">-TypeName</span> <span class="pre">System.Net.WebClient).downloadString('https://raw.githubusercontent.com/OsbornePro/BTPS-SecPack/master/Installer.ps1')</span></code></p></li>
<li><p>The installation of the B.T.P.S Security Package should then start. Some Next Generation Anti-Virus providers may block script execution in this manner. If that is the case use the below method to accomplish the same task.</p></li>
</ol>
<p><strong>IF ABOVE COMMAND METHOD DOES NOT WORK</strong>
Some Next Generation Anti-Virus providers may block script execution in this manner. If that is the case use the below method to accomplish the same task.</p>
<ol class="arabic simple">
<li><p>Log into your Primary Domain Controller using an account with Administrator permissions.</p></li>
<li><p>Open an Administrative PowerShell session (Windows Key + X, The press A).</p></li>
<li><p>The command displayed in step 4 will download the script to your disk in your Downloads directory. Copy and paste the command into your admin powershell session and press ENTER to execute it.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Invoke-WebRequest</span> <span class="pre">-Uri</span> <span class="pre">&quot;https://raw.githubusercontent.com/OsbornePro/BTPS-SecPack/master/Installer.ps1&quot;</span> <span class="pre">-OutFile</span> <span class="pre">&quot;$env:USERPROFILE\Downloads\Installer.ps1&quot;</span></code></p></li>
<li><p>Execute the command line in step 6 to ensure your Execution Policy allows the script to execute easily. Copy and paste the command into your admin powershell session and press ENTER to execute it.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Set-ExecutionPolicy</span> <span class="pre">RemoteSigned</span> <span class="pre">-Force</span></code></p></li>
<li><p>Execute the command line in step 8 to run the script and being installation. Include the period at the beginning of the command. Copy and paste the command into your admin powershell session and press ENTER to execute it.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">.&quot;$env:USERPROFILE\Downlods\Installer.ps1&quot;</span></code></p></li>
<li><p>The installation of the B.T.P.S. Security Package should then begin.</p></li>
</ol>
<p><strong>OTHER DOWNLOAD FILE COMMANDS</strong>
As an FYI there are multiple ways to download files from the PowerShell session. If <code class="docutils literal notranslate"><span class="pre">Invoke-WebRequest</span></code> is blocked or does not work for you try the below commands instead. Each command does the same thing in a different way and each command is one line.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">(New-Object</span> <span class="pre">Net.WebClient).DownloadFile('https://raw.githubusercontent.com/OsbornePro/BTPS-SecPack/master/Installer.ps1',</span> <span class="pre">&quot;$env:USERPROFILE\Downloads\Installer.ps1&quot;)</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Start-BitsTransfer</span> <span class="pre">&quot;https://raw.githubusercontent.com/OsbornePro/BTPS-SecPack/master/Installer.ps1&quot;</span> <span class="pre">-Destinations</span> <span class="pre">&quot;$env:USERPROFILE\Downloads\Installer.ps1&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">certutil.exe</span> <span class="pre">-urlcache</span> <span class="pre">-split</span> <span class="pre">-f</span> <span class="pre">https://raw.githubusercontent.com/OsbornePro/BTPS-SecPack/master/Installer.ps1</span> <span class="pre">&quot;$env:USERPROFILE\Downloads\Installer.ps1&quot;</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bitsadmin</span> <span class="pre">/transfer</span> <span class="pre">debjob</span> <span class="pre">/download</span> <span class="pre">/priority</span> <span class="pre">normal</span> <span class="pre">https://raw.githubusercontent.com/OsbornePro/BTPS-SecPack/master/Installer.ps1&quot;</span> <span class="pre">&quot;$env:USERPROFILE\Downloads\Installer.ps1&quot;</span></code></p></li>
</ul>
</div>
<div class="section" id="configure-winrm-over-https">
<h3>Configure WinRM over HTTPS<a class="headerlink" href="#configure-winrm-over-https" title="Permalink to this headline">¶</a></h3>
<p>I cover the settings configured for WinRM over HTTPS communication through the use of Group Policy. These settings can be seen in the sections below.
<a class="reference external" href="https://youtu.be/UcU2Iu9AXpM">Configure WinRM over HTTPS Instructions</a></p>
</div>
</div>
<div class="section" id="useful-winrm-info-and-commands-to-know">
<h2>Useful WinRM Info and Commands To Know<a class="headerlink" href="#useful-winrm-info-and-commands-to-know" title="Permalink to this headline">¶</a></h2>
<p>Setup WinRM over HTTPS may require the need to know a few commands. I have included these commands below.</p>
<p><code class="docutils literal notranslate"><span class="pre">Enable-PSRemoting</span> <span class="pre">-Force</span> <span class="pre">#</span> <span class="pre">Enables</span> <span class="pre">firewall</span> <span class="pre">rules</span> <span class="pre">for</span> <span class="pre">WinRM</span></code>
<code class="docutils literal notranslate"><span class="pre">winrm</span> <span class="pre">qc</span> <span class="pre">-q</span> <span class="pre">#</span> <span class="pre">Qucik</span> <span class="pre">config</span> <span class="pre">for</span> <span class="pre">WinRM</span> <span class="pre">5985</span></code>
<code class="docutils literal notranslate"><span class="pre">winrm</span> <span class="pre">enum</span> <span class="pre">winrm/config/listener</span> <span class="pre">#</span> <span class="pre">Enumerate</span> <span class="pre">cert</span> <span class="pre">thumbprint</span> <span class="pre">used</span> <span class="pre">on</span> <span class="pre">different</span> <span class="pre">winrm</span> <span class="pre">ports</span></code>
<code class="docutils literal notranslate"><span class="pre">winrm</span> <span class="pre">delete</span> <span class="pre">winrm/config/listener?Address=*+Transport=HTTPS</span> <span class="pre">#</span> <span class="pre">Delete</span> <span class="pre">winrm</span> <span class="pre">certificate</span> <span class="pre">and</span> <span class="pre">stop</span> <span class="pre">listener</span> <span class="pre">on</span> <span class="pre">5986.</span> <span class="pre">This</span> <span class="pre">allows</span> <span class="pre">new</span> <span class="pre">cert</span> <span class="pre">to</span> <span class="pre">be</span> <span class="pre">attached</span> <span class="pre">to</span> <span class="pre">port</span></code>
<code class="docutils literal notranslate"><span class="pre">winrm</span> <span class="pre">create</span> <span class="pre">winrm/config/listener?Address=*+Transport=HTTPS</span> <span class="pre">#</span> <span class="pre">Creates</span> <span class="pre">a</span> <span class="pre">WinRM</span> <span class="pre">listener</span> <span class="pre">on</span> <span class="pre">5986</span> <span class="pre">using</span> <span class="pre">any</span> <span class="pre">available</span> <span class="pre">certificate</span></code></p>
<p>The below command defines a certificate to use on port 5986. Certificate Template needed is a Web Server certificate from Windows PKI
<code class="docutils literal notranslate"><span class="pre">New-WSManInstance</span> <span class="pre">-ResourceUri</span> <span class="pre">WinRM/Config/Listener</span> <span class="pre">-SelectorSet</span> <span class="pre">&#64;{Address</span> <span class="pre">=</span> <span class="pre">&quot;*&quot;;</span> <span class="pre">Transport</span> <span class="pre">=</span> <span class="pre">&quot;HTTPS&quot;}</span> <span class="pre">-ValueSet</span> <span class="pre">&#64;{Hostname</span> <span class="pre">=</span> <span class="pre">FqdnRequiredHere.domain.com;</span> <span class="pre">CertificateThumbprint</span> <span class="pre">=</span> <span class="pre">$Thumbprint</span> <span class="pre">}</span></code></p>
<p><strong>SERVER CERTIFICATE:</strong>
The certificate thumbprint value that you are going to need in “Group Policy Setting 1” below is from your internal domains Private Key Infrastructure (PKI). This value will vary as these values are unique to the certificate. The Root Certificate Authority (CA) assigns certificates to your devices. When a device receives a certificate, it gets assigned under the Root CA’s certificate. This creates what is called a Certificate Chain. If it helps to see this represented in a directory tree format, it would look something like the below tree structure. Your domain would not have an Intermediate CA most likely but I included it for the visual.</p>
<ul class="simple">
<li><dl class="simple">
<dt>Root CA Certificate &lt;– This is the certificate thumbprint you need</dt><dd><ul>
<li><dl class="simple">
<dt>Intermediate CA Certificate</dt><dd><ul>
<li><p>Assigned Device Certificate</p></li>
<li><p>Assigned Device Certificate &lt;– This certificate’s thumbprint gets assigned to port 5986 on the client device.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
</ul>
<p><strong>CLIENT CERTIFICATE:</strong>
* In the above tree, “Assigned Device Certificate” is where the command
<code class="docutils literal notranslate"><span class="pre">New-WSManInstance</span> <span class="pre">-ResourceUri</span> <span class="pre">WinRM/Config/Listener</span> <span class="pre">-SelectorSet</span> <span class="pre">&#64;{Address</span> <span class="pre">=</span> <span class="pre">&quot;*&quot;;</span> <span class="pre">Transport</span> <span class="pre">=</span> <span class="pre">&quot;HTTPS&quot;}</span> <span class="pre">-ValueSet</span> <span class="pre">&#64;{Hostname</span> <span class="pre">=</span> <span class="pre">FqdnRequiredHere.domain.com;</span> <span class="pre">CertificateThumbprint</span> <span class="pre">=</span> <span class="pre">$Thumbprint</span> <span class="pre">}</span></code>
would come in.
* Notice the “Hostname” value includes the domain you are in. This needs to also be true for the “Common Name” value when the client device requests the WinRM certificate. This means your CN value is required to be devicename.domainname.com. If you do not include the domain name in the Common Name value your WinRM over HTTPS communication will not work. Subject Alternative Name’s (SAN) will not work either. I have tried adding more than one Common Name values to a certificate and this communication still failed.
* If you are using a Windows Server Certificate Authority, the “WebServer” certificate template can be used to request the certificate needed.</p>
</div>
<div class="section" id="group-policy-windows-event-forwarding-wef-settings">
<h2>Group Policy Windows Event Forwarding (WEF) Settings<a class="headerlink" href="#group-policy-windows-event-forwarding-wef-settings" title="Permalink to this headline">¶</a></h2>
<p><strong>GROUP POLICY SETTING 1</strong></p>
<p>The Group Policy setting “Computer Configuration &gt; Policies &gt; Administrative Templates &gt; Windows Components &gt; Event Forwarding &gt; Configure Target Subscription Manager” needs to be set to WinRM over HTTPS (Port 5986): In my environment I added 2 entries for this to cover all basis. One has the CA certificate thumbprint with with spaces after every 2 numbers, and the other entry is without spaces. The example values are below.</p>
<p>1. <strong>Example Entry 1</strong>
<code class="docutils literal notranslate"><span class="pre">Server=https://wef.domain.com:5986/wsman/SubscriptionManager/WEC,Refresh=900,IssuerCA=ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span> <span class="pre">ff</span></code></p>
<p>2. <strong>Example Entry 2</strong>
<code class="docutils literal notranslate"><span class="pre">Server=https://wef.domain.com:5986/wsman/SubscriptionManager/WEC,Refresh=900,IssuerCA=ffffffffffffffffffffffffffffffffffffffff</span></code>
<strong>NOTE:</strong> The default Refresh rate value is 900 seconds or 15 minutes. This does not need to be defined. I included it to be thorough.</p>
<p>3. <strong>Example Entry 3</strong>
Using the below value without a certificate defined will allow/use Kerberos for authentication which is fine to use
<code class="docutils literal notranslate"><span class="pre">Server=https://wef.domain.com:5986/wsman/SubscriptionManager/WEC,Refresh=900</span></code></p>
<p><strong>GROUP POLICY SETTING 2</strong></p>
<p>The Group Policy Setting “Computer Configuration &gt; Policies &gt; Administrative Templates &gt; Windows Components &gt; Event Log Service &gt; Security &gt; Change Log Access” needs to be set to the value of the property “ChannelAccess” after issuing the below command:
<code class="docutils literal notranslate"><span class="pre">wevtutil</span> <span class="pre">gl</span> <span class="pre">security</span></code></p>
<p>Group Policy Setting “Computer Configuration &gt; Policies &gt; Administrative Templates &gt; Windows Components &gt; Event Log Service &gt; Security &gt; Change Log Access (Legacy)” needs to be set to the value of the property “ChannelAccess” after issuing the below command:
<code class="docutils literal notranslate"><span class="pre">wevtutil</span> <span class="pre">gl</span> <span class="pre">security</span></code></p>
</div>
<div class="section" id="group-policy-winrm-settings">
<h2>Group Policy WinRM Settings<a class="headerlink" href="#group-policy-winrm-settings" title="Permalink to this headline">¶</a></h2>
<p><strong>GROUP POLICY SETTING 3</strong></p>
<p>In your group policy settings go to “Computer Configuration &gt; Preferences &gt; Control Panel Settings &gt; Services”. Then right click and add a New Service. Set the “Startup Type” to “Automatic”. Set the “Service Name” to WinRM, set the “Service Action” to “Start Service”, set the “Wait Timeout” to 30 seconds. In the recovery tab select “Restart the Service” from the three failure options. Set “Reset Fail Count after” to 0 days and “Reset Service after” to 1 minutes. Then click OK to save.</p>
<p><strong>GROUP POLICY SETTING 4</strong></p>
<p>Next, still on the same policy object, is the list of IP addresses that are allowed to do remote management access  on the target computer. Go to Computer Configuration &gt; Policies &gt; Administrative Templates &gt; Windows Components &gt; Windows Remote Management (WinRM) &gt; WinRM Services. Then double click on “Allow remote server management through WinRM” to modify the setting as follows:
Set the policy to “Enabled”
Set the IPv4 Filter to * or an all encompassing subnet for your environment such as <code class="docutils literal notranslate"><span class="pre">10.0.0.0/16</span></code>
Leave the IPv6 Filter blank or set it to a wildcard * as well. Click OK to save.</p>
<p><strong>GROUP POLICY SETTING 5</strong></p>
<p>Edit the settings — Opening Firewall ports
Next we will create a new rule for the Firewall on the targeted client PC’s. Go to Computer  Configurations &gt; Policies &gt; Security Settings &gt; Windows  Firewall and Advanced Security &gt; Windows Firewall and Advanced  Security then right click on Inbound Rules &gt; New Rule</p>
<p>Create a new rule called Allow WinRM over HTTPS. We want to allow the inbound connection on port 5986. Leave the Tick mark on “Domain” and “Private”. We then want to create a few more firewall rules using the default firewall rules “Remote Event Log Management (RPC-EPMAP)”, “Remote Event Monitor (RPC-EPMAP)”, “Remote Event Log Management (RPC)”, “Remote Event Monitor (RPC)”, “Remote Service Management (RPC-EPMAP)”, “Remote Service Management (RPC)”, “Remote Scheduled Tasks Management (RPC-EPMAP)”, “Remote Scheduled Tasks Management (RPC)”. This should be enabled to Allow inbound traffic in the “Domain”, and “Private” profiles.  For good measure if you like you can deny traffic on port 5985. This is done by adding firewall default firewall rule “Windows Remote Management (HTTP-In)”, and Blocking traffic to that port.</p>
<p><strong>GROUP POLICY SETTING 6</strong></p>
<p>Under Administrative Templates &gt; Network &gt; Network Connections &gt; Windows Defender Firewall &gt; Domain Profile set the policies for Windows Defender Firewall: Allow ICMP exceptions, Windows Defender Firewall: Allow inbound remote administration exception, and Windows Defender Firewall: Allow inbound Remote Desktop exceptions to “Enabled”. Define the filter you used in Group Policy Setting 4 for these allowed values. For example you may have used a Wildcard * or defined an all encompassing subnet range such as <code class="docutils literal notranslate"><span class="pre">10.0.0.0/16</span></code></p>
<p><strong>GROUP POLICY SETTING 7</strong></p>
<p>Under Administrative Templates &gt; System &gt; Credentials Delegation &gt; Allow delegating fresh credentials and set the values to <code class="docutils literal notranslate"><span class="pre">WSMAN/*.yourdomain.com</span></code>. This will allow WinRM communication between any host ending in yourdomain.com. Then set “Allow delegating fresh credentials with NTLM-only server authentication” under that same tree to that value <code class="docutils literal notranslate"><span class="pre">WSMAN/*.yourdomain.com</span></code>. For example my email <a class="reference external" href="mailto:rosborne&#37;&#52;&#48;osbornepro&#46;com">rosborne<span>&#64;</span>osbornepro<span>&#46;</span>com</a> is in the domain osbornepro.com. I would set the value to <code class="docutils literal notranslate"><span class="pre">WSMAN/*.osbornepro.com</span></code>. We also want to Enable “Encryption Oracle Remediation” and set the drop down value to “Force Updated Clients”. This is to prevent CVE-2018-0886 exploitation.</p>
<p><strong>GROUP POLICY SETTING 8</strong></p>
<p>Under Administrative Templates &gt; Windows Components/Windows Remote Management (WinRM)/WinRM Client set the below settings.</p>
<p>Allow Basic authentication Enabled
Allow CredSSP authentication Enabled
Allow remote server management through WinRM Enabled
IPv4 filter: *
IPv6 filter: *
Allow unencrypted traffic Disabled
Disallow Kerberos authentication Disabled  # If you are have CCPD than enable this
Disallow WinRM from storing RunAs credentials Enabled</p>
<p><strong>GROUP POLICY SETTING 9</strong></p>
<p>Under Administrative Templates &gt; Windows Components/Windows Remote Management (WinRM)/WinRM Service set the below settings</p>
<p>Allow Basic authentication Enabled
Allow CredSSP authentication Enabled
Allow remote server management through WinRM Enabled
IPv4 filter: *
IPv6 filter: *
Allow unencrypted traffic Disabled
Disallow Kerberos authentication Disabled
Disallow WinRM from storing RunAs credentials Enabled
Turn On Compatibility HTTP Listener Disabled
Turn On Compatibility HTTPS Listener Enabled</p>
<p><strong>GROUP POLICY SETTING 10</strong>
Create a Registry Setting that gets pushed out through Group Policy containing the below value</p>
<p><strong>SETTING:</strong>
<code class="docutils literal notranslate"><span class="pre">HKLM:\Software\Policies\Microsoft\Windows</span> <span class="pre">NT\CurrentVersion\NetworkList\Signatures\010103000F0000F0010000000F0000F0C967A3643C3AD745950DA7859209176EF5B87C875FA20DF21951640E807D7C24\Category</span></code>
<code class="docutils literal notranslate"><span class="pre">State</span></code>
<code class="docutils literal notranslate"><span class="pre">1</span></code></p>
<p><strong>CONCLUSION</strong>
WinRM over HTTPS is now configured for your environment. Great work! When you now use PowerShell commands such as <code class="docutils literal notranslate"><span class="pre">Invoke-Command</span></code> or <code class="docutils literal notranslate"><span class="pre">New-PSSession</span></code> you will need to specify the <code class="docutils literal notranslate"><span class="pre">-UseSSL</span></code> parameter in order to use WinRM over HTTPS. Port 5985 will not accept connections in an ideal setup.</p>
</div>
<div class="section" id="download-an-instructional-pdf-with-images-and-descriptions-for-installer-ps1-at-the-below-link">
<h2>Download an Instructional PDF with images and descriptions for Installer.ps1 at the below link<a class="headerlink" href="#download-an-instructional-pdf-with-images-and-descriptions-for-installer-ps1-at-the-below-link" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/OsbornePro/Documents/raw/main/Installer.ps1%20Demo.pdf">https://github.com/OsbornePro/Documents/raw/main/Installer.ps1%20Demo.pdf</a></p>
</div>
<div class="section" id="download-an-instructional-pdf-with-images-and-descriptions-for-installing-sysmon-at-the-below-link">
<h2>Download an Instructional PDF with images and descriptions for installing Sysmon at the below link<a class="headerlink" href="#download-an-instructional-pdf-with-images-and-descriptions-for-installing-sysmon-at-the-below-link" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://github.com/OsbornePro/Documents/raw/main/Sysmon%20Setup-0001.pdf">https://github.com/OsbornePro/Documents/raw/main/Sysmon%20Setup-0001.pdf</a></p>
</div>
<div class="section" id="disclaimer">
<h2>Disclaimer<a class="headerlink" href="#disclaimer" title="Permalink to this headline">¶</a></h2>
<p><strong>DISCLAIMER:</strong> This suite nor any other security suite or tool can completely prevent or detect all security vulnerabilities. This tool adds monitoring to an environment and may not catch every possible scenario and is no guarantee of discovery.</p>
<div class="toctree-wrapper compound">
</div>
<div class="section" id="indices-and-tables">
<h3>Indices and tables<a class="headerlink" href="#indices-and-tables" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p><a class="reference internal" href="genindex.html"><span class="std std-ref">Index</span></a></p></li>
<li><p><a class="reference internal" href="py-modindex.html"><span class="std std-ref">Module Index</span></a></p></li>
<li><p><a class="reference internal" href="search.html"><span class="std std-ref">Search Page</span></a></p></li>
</ul>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Robert H. Osborne.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-145050521-2', 'auto');
    
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>